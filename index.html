<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kedai Kebun Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; }
        .product-card { background: white; border-radius: 25px; border: 1px solid #e2e8f0; }
        .btn-order { background: #10b981; color: white; font-weight: 800; border-radius: 12px; }
    </style>
</head>
<body class="p-5">
    <div class="max-w-md mx-auto space-y-6">
        <div class="text-center">
            <h1 class="text-2xl font-black text-slate-900">KEDAI KEBUN PRO</h1>
            <p class="text-xs text-slate-400 font-bold uppercase tracking-widest">Sila isi borang di bawah untuk memesan</p>
        </div>

        <div id="productList" class="space-y-4"></div>

        <div class="pt-6 border-t">
            <h2 class="font-black text-slate-800 mb-3 text-sm uppercase">Pesanan Terkini</h2>
            <div id="orderLog" class="space-y-2"></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = "https://gbjrvrdsmajwajnhsodt.supabase.co";
        const SUPABASE_KEY = "sb_publishable_fp0mnEYNTgc7QexmOP3njg_VK6W6832";
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const urlParams = new URLSearchParams(window.location.search);
        const farmerId = urlParams.get('id');

        async function muatKedai() {
            const { data: products } = await _supabase.from('produk').select('*').eq('user_id', farmerId).gt('stok_kg', 0);
            const list = document.getElementById('productList');
            
            if (products && products.length > 0) {
                list.innerHTML = products.map(p => `
                    <div class="product-card p-5 shadow-sm space-y-3">
                        <div class="flex justify-between items-center">
                            <h3 class="font-black text-lg text-slate-800 uppercase">${p.nama_barang}</h3>
                            <span class="bg-emerald-100 text-emerald-600 px-3 py-1 rounded-full text-[10px] font-bold">RM ${p.harga_kg}/kg</span>
                        </div>
                        <div class="space-y-2">
                            <input id="nama_${p.id}" placeholder="Nama Anda" class="w-full p-3 bg-slate-50 border rounded-xl text-sm outline-none focus:border-emerald-500">
                            <input id="tel_${p.id}" placeholder="No. Tel (6012...)" class="w-full p-3 bg-slate-50 border rounded-xl text-sm outline-none focus:border-emerald-500">
                            <input id="berat_${p.id}" type="number" placeholder="Berapa KG?" class="w-full p-3 bg-slate-50 border rounded-xl text-sm outline-none focus:border-emerald-500">
                            <button onclick="hantarPesanan('${p.nama_barang}', ${p.harga_kg}, ${p.id})" class="w-full btn-order py-3 shadow-md">HANTAR PESANAN</button>
                        </div>
                    </div>
                `).join('');
            }
            muatLog();
        }

        async function hantarPesanan(produk, harga, id) {
            const nama = document.getElementById(`nama_${id}`).value;
            const tel = document.getElementById(`tel_${id}`).value;
            const berat = document.getElementById(`berat_${id}`).value;

            if(!nama || !tel || !berat) return Swal.fire("Info", "Lengkapkan semua kotak", "info");

            const total = parseFloat(harga) * parseFloat(berat);

            const { error } = await _supabase.from('pesanan').insert([{
                peladang_id: farmerId,
                nama_pelanggan: nama,
                no_tel: tel,
                produk_nama: produk,
                berat_kg: berat,
                jumlah_harga: total
            }]);

            if(!error) {
                Swal.fire("Berjaya", "Pesanan direkodkan!", "success");
                muatLog();
            } else {
                Swal.fire("Ralat", error.message, "error");
            }
        }

        async function muatLog() {
            const { data: logs } = await _supabase.from('pesanan').select('*').eq('peladang_id', farmerId).order('id', {ascending: false}).limit(3);
            const logDiv = document.getElementById('orderLog');
            if(logs && logs.length > 0) {
                logDiv.innerHTML = logs.map(l => `
                    <div class="bg-white p-3 rounded-xl border text-[11px] shadow-sm flex justify-between">
                        <span><b>${l.nama_pelanggan}</b> beli ${l.produk_nama}</span>
                        <span class="text-slate-400">Baru tadi</span>
                    </div>
                `).join('');
            }
        }
        window.onload = muatKedai;
    </script>
</body>
</html>
