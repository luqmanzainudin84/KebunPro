<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kedai Kebun Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; }
        .product-card { background: white; border-radius: 30px; border: 1px solid #e2e8f0; overflow: hidden; }
        .btn-order { background: #10b981; color: white; font-weight: 800; border-radius: 15px; text-transform: uppercase; letter-spacing: 1px; }
        .loading-shimmer { color: #10b981; font-weight: 800; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body class="p-5">

    <div class="max-w-md mx-auto space-y-8">
        <div class="text-center space-y-2">
            <h1 class="text-3xl font-black text-slate-900 tracking-tighter">KEDAI KEBUN PRO</h1>
            <span class="bg-emerald-100 text-emerald-600 px-4 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest">Hasil Segar Dari Ladang</span>
        </div>

        <div id="productList" class="space-y-6">
            <div class="text-center py-20">
                <p class="loading-shimmer">MEMUATKAN KEDAI...</p>
            </div>
        </div>
    </div>

    <script>
        // Konfigurasi Supabase
        const SUPABASE_URL = "https://gbjrvrdsmajwajnhsodt.supabase.co";
        const SUPABASE_KEY = "sb_publishable_fp0mnEYNTgc7QexmOP3njg_VK6W6832";
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Ambil ID Peladang dari URL (?id=xxxx)
        const urlParams = new URLSearchParams(window.location.search);
        const farmerId = urlParams.get('id');

        async function muatKedai() {
            if (!farmerId) {
                document.getElementById('productList').innerHTML = `
                    <div class="text-center p-10 bg-red-50 rounded-3xl border border-red-100">
                        <p class="text-red-500 font-bold text-sm text-wrap">RALAT: Link tidak sah. Sila dapatkan link betul dari peladang.</p>
                    </div>`;
                return;
            }

            const { data: products, error } = await _supabase
                .from('produk')
                .select('*')
                .eq('user_id', farmerId)
                .gt('stok_kg', 0);

            const list = document.getElementById('productList');

            if (error) {
                list.innerHTML = `<p class="text-center text-red-500">Ralat: ${error.message}</p>`;
                return;
            }

            if (products && products.length > 0) {
                list.innerHTML = products.map(p => `
                    <div class="product-card p-6 shadow-sm space-y-4">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="font-black text-xl text-slate-800 uppercase">${p.nama_barang}</h3>
                                <p class="text-emerald-600 font-black text-2xl">RM ${p.harga_kg.toFixed(2)}<span class="text-[10px] text-slate-400">/KG</span></p>
                            </div>
                            <div class="text-right bg-slate-50 p-2 rounded-xl border border-slate-100">
                                <p class="text-[9px] font-bold text-slate-400 uppercase">Stok</p>
                                <p class="font-bold text-slate-700">${p.stok_kg}KG</p>
                            </div>
                        </div>
                        
                        <div class="pt-4 border-t border-dashed border-slate-200 space-y-3">
                            <p class="text-[10px] font-bold text-slate-400 uppercase ml-1">Borang Pesanan Cepat</p>
                            <input id="nama_${p.id}" type="text" placeholder="Nama Anda" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl text-sm outline-none focus:border-emerald-500">
                            <input id="berat_${p.id}" type="number" placeholder="Berapa KG mahu beli?" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl text-sm outline-none focus:border-emerald-500">
                            <button onclick="prosesPesanan('${p.nama_barang}', ${p.harga_kg}, ${p.id}, ${p.stok_kg})" class="w-full btn-order py-4 shadow-lg active:scale-95 transition-all">
                                PESAN SEKARANG
                            </button>
                        </div>
                    </div>
                `).join('');
            } else {
                list.innerHTML = `
                    <div class="text-center py-20 bg-white rounded-[40px] border border-slate-100 shadow-sm">
                        <p class="text-slate-400 font-bold uppercase text-xs tracking-widest text-wrap px-4">Maaf, kedai ini belum mempunyai stok buat masa ini.</p>
                    </div>`;
            }
        }

        function prosesPesanan(namaBarang, harga, id, stokAsal) {
            const namaPelanggan = document.getElementById(`nama_${id}`).value;
            const beratDipesan = document.getElementById(`berat_${id}`).value;

            if (!namaPelanggan || !beratDipesan) {
                Swal.fire("Info", "Sila isi Nama dan Berat pesanan anda", "info");
                return;
            }

            if (parseFloat(beratDipesan) > stokAsal) {
                Swal.fire("Maaf", `Stok tidak mencukupi. Maksimum: ${stokAsal}kg`, "warning");
                return;
            }

            const jumlahHarga = (parseFloat(harga) * parseFloat(beratDipesan)).toFixed(2);
            const mesej = `Salam, saya *${namaPelanggan}*.\nSaya ingin beli *${namaBarang}* seberat *${beratDipesan}kg*.\n\nTotal: *RM ${jumlahHarga}*`;
            
            const waLink = `https://wa.me/60123456789?text=${encodeURIComponent(mesej)}`; // Sila tukar no tel peladang kpd dinamik nanti
            
            window.open(waLink, '_blank');
        }

        window.onload = muatKedai;
    </script>
</body>
</html>
