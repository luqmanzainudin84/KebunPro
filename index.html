<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kedai Kebun Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; color: #1e293b; }
        .card-order { background: white; border-radius: 24px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
        input, select { background: #f1f5f9 !important; border: 1px solid #e2e8f0 !important; border-radius: 12px !important; padding: 12px !important; font-size: 14px !important; width: 100%; }
        .btn-submit { background: #10b981; color: white; font-weight: 800; padding: 16px; border-radius: 16px; transition: all 0.2s; width: 100%; }
        .btn-submit:disabled { background: #94a3b8; cursor: not-allowed; }
        label { font-size: 11px; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 6px; display: block; }
    </style>
</head>
<body class="p-4 pb-20">

    <div class="max-w-md mx-auto space-y-6">
        <div class="text-center py-6">
            <h1 class="text-2xl font-black text-slate-900 uppercase tracking-tight">Kedai Kebun Pro</h1>
            <p class="text-slate-500 text-sm font-medium">Sila isi borang di bawah untuk memesan</p>
        </div>

        <div class="card-order p-6 space-y-5">
            <div>
                <label>Pilih Produk</label>
                <select id="pilihan_produk" onchange="kemaskiniHarga()">
                    <option value="">-- Sila Pilih --</option>
                </select>
            </div>

            <div id="info_produk" class="hidden grid grid-cols-2 gap-3 animate-fade-in">
                <div class="bg-green-50 p-3 rounded-xl border border-green-100 text-center">
                    <p class="text-[10px] text-green-600 font-bold uppercase">Harga</p>
                    <p id="display_harga" class="text-lg font-black text-green-700">RM 0/KG</p>
                </div>
                <div class="bg-blue-50 p-3 rounded-xl border border-blue-100 text-center">
                    <p class="text-[10px] text-blue-600 font-bold uppercase">Stok Tersedia</p>
                    <p id="display_stok" class="text-lg font-black text-blue-700">0 KG</p>
                </div>
                <div id="box_lokasi" class="col-span-2 bg-slate-50 p-3 rounded-xl border border-slate-200">
                    <p class="text-[10px] text-slate-500 font-bold uppercase">üìç Lokasi Jualan</p>
                    <p id="display_lokasi" class="text-sm font-bold text-slate-700">--</p>
                    <a id="link_maps" href="#" target="_blank" class="text-[11px] text-blue-600 font-black underline mt-2 block">BUKA MAPS & ARAH JALAN üîó</a>
                </div>
            </div>

            <div class="space-y-4 pt-2">
                <div>
                    <label>Nama Anda</label>
                    <input type="text" id="nama_pelanggan" placeholder="Masukkan nama penuh">
                </div>
                <div>
                    <label>No. Telefon</label>
                    <input type="tel" id="no_tel" placeholder="0123456789">
                </div>
                <div>
                    <label>Berapa KG?</label>
                    <input type="number" id="berat_kg" placeholder="0.0" oninput="kiraTotal()">
                </div>
            </div>

            <div class="pt-4 border-t border-slate-100">
                <div class="flex justify-between items-center mb-4 px-1">
                    <span class="text-xs font-bold text-slate-500">ESTIMASI JUMLAH</span>
                    <span id="total_bayar" class="text-2xl font-black text-slate-900">RM 0.00</span>
                </div>
                <button id="btnHantar" onclick="hantarPesanan()" class="btn-submit">HANTAR PESANAN SEKARANG</button>
            </div>
        </div>

        <div class="space-y-3">
            <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest px-1">Pesanan Terkini</h3>
            <div id="logContainer" class="space-y-2"></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = "https://gbjrvrdsmajwajnhsodt.supabase.co";
        const SUPABASE_KEY = "sb_publishable_fp0mnEYNTgc7QexmOP3njg_VK6W6832";
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const urlParams = new URLSearchParams(window.location.search);
        const farmerId = urlParams.get('id');
        let senaraiProduk = [];
        let produkTerpilih = null;

        async function muatData() {
            if (!farmerId) return;

            // 1. Ambil data produk asal
            const { data: pData } = await _supabase.from('produk').select('*').eq('user_id', farmerId);
            
            // 2. Ambil semua pesanan untuk tolak stok
            const { data: oData } = await _supabase.from('pesanan').select('produk_nama, berat_kg').eq('peladang_id', farmerId);

            if (pData) {
                senaraiProduk = pData.map(p => {
                    const terjual = oData ? oData.filter(o => o.produk_nama === p.nama_barang).reduce((s, o) => s + parseFloat(o.berat_kg), 0) : 0;
                    return { ...p, baki_stok: p.stok_kg - terjual };
                });

                const select = document.getElementById('pilihan_produk');
                select.innerHTML = '<option value="">-- Sila Pilih Produk --</option>';
                senaraiProduk.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.id;
                    opt.innerText = `${p.nama_barang} (Baki: ${p.baki_stok.toFixed(1)}kg)`;
                    select.appendChild(opt);
                });
            }
            muatLog();
        }

        function kemaskiniHarga() {
            const id = document.getElementById('pilihan_produk').value;
            produkTerpilih = senaraiProduk.find(p => p.id == id);
            const infoBox = document.getElementById('info_produk');

            if (produkTerpilih) {
                infoBox.classList.remove('hidden');
                document.getElementById('display_harga').innerText = `RM ${produkTerpilih.harga_kg}/KG`;
                
                const baki = produkTerpilih.baki_stok;
                const stokEle = document.getElementById('display_stok');
                stokEle.innerText = `${baki.toFixed(1)} KG`;
                stokEle.className = baki <= 0 ? "text-lg font-black text-red-600" : "text-lg font-black text-blue-700";

                document.getElementById('display_lokasi').innerText = produkTerpilih.lokasi || "Sila rujuk admin";
                
                const linkMaps = document.getElementById('link_maps');
                if(produkTerpilih.google_maps) {
                    linkMaps.href = `https://www.google.com/maps/search/?api=1&query=${produkTerpilih.google_maps}`;
                    linkMaps.classList.remove('hidden');
                } else {
                    linkMaps.classList.add('hidden');
                }

                // Disable button jika sold out
                document.getElementById('btnHantar').disabled = baki <= 0;
                document.getElementById('btnHantar').innerText = baki <= 0 ? "STOK HABIS" : "HANTAR PESANAN SEKARANG";

            } else {
                infoBox.classList.add('hidden');
            }
            kiraTotal();
        }

        function kiraTotal() {
            const berat = parseFloat(document.getElementById('berat_kg').value) || 0;
            const harga = produkTerpilih ? produkTerpilih.harga_kg : 0;
            document.getElementById('total_bayar').innerText = `RM ${(berat * harga).toFixed(2)}`;
        }

        async function hantarPesanan() {
            const nama = document.getElementById('nama_pelanggan').value;
            const tel = document.getElementById('no_tel').value;
            const berat = parseFloat(document.getElementById('berat_kg').value);

            if (!produkTerpilih || !nama || !tel || !berat) {
                return Swal.fire("Ralat", "Sila isi semua maklumat", "error");
            }

            if (berat > produkTerpilih.baki_stok) {
                return Swal.fire("Stok Tidak Cukup", `Baki stok hanya tinggal ${produkTerpilih.baki_stok}kg`, "warning");
            }

            const total = parseFloat(produkTerpilih.harga_kg) * berat;

            const { error } = await _supabase.from('pesanan').insert([{
                peladang_id: farmerId,
                nama_pelanggan: nama,
                no_tel: tel,
                produk_nama: produkTerpilih.nama_barang,
                berat_kg: berat,
                jumlah_harga: total
            }]);

            if (error) {
                Swal.fire("Ralat", error.message, "error");
            } else {
                await Swal.fire("Berjaya", "Pesanan anda telah diterima!", "success");
                location.reload(); 
            }
        }

        async function muatLog() {
            const { data } = await _supabase.from('pesanan').select('*').eq('peladang_id', farmerId).order('created_at', { ascending: false }).limit(5);
            const container = document.getElementById('logContainer');
            if (data) {
                container.innerHTML = data.map(o => `
                    <div class="bg-white p-3 rounded-xl border border-slate-200 flex justify-between items-center shadow-sm">
                        <div>
                            <p class="text-[9px] font-black uppercase text-slate-400 leading-none">${o.produk_nama}</p>
                            <p class="text-sm font-bold text-slate-700">${o.nama_pelanggan}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-black text-green-600">RM ${o.jumlah_harga.toFixed(2)}</p>
                            <p class="text-[9px] font-bold text-slate-400 uppercase">${o.status_bayar ? '‚úÖ Dibayar' : '‚åõ Pending'}</p>
                        </div>
                    </div>
                `).join('');
            }
        }

        window.onload = muatData;
    </script>
</body>
</html>
