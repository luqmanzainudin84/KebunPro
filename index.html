<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kedai Kebun Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; color: #1e293b; }
        .product-card { background: white; border-radius: 30px; border: 1px solid #e2e8f0; transition: 0.3s; }
        .product-card:active { transform: scale(0.98); }
        .btn-order { background: #10b981; color: white; border-radius: 20px; font-weight: 800; }
    </style>
</head>
<body class="pb-20">

    <div class="max-w-md mx-auto px-6 pt-10 space-y-8">
        <div class="text-center space-y-2">
            <h1 id="shopName" class="text-3xl font-black text-slate-900 uppercase tracking-tighter">Memuatkan Kedai...</h1>
            <p class="text-xs font-bold text-emerald-600 bg-emerald-100 inline-block px-4 py-1 rounded-full uppercase">Hasil Segar Dari Ladang</p>
        </div>

        <div id="productList" class="space-y-4">
            <div class="text-center py-10 text-slate-400">Mencari hasil kebun...</div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = "https://gbjrvrdsmajwajnhsodt.supabase.co";
        const SUPABASE_KEY = "sb_publishable_fp0mnEYNTgc7QexmOP3njg_VK6W6832";
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Ambil ID Peladang dari URL (Cth: index.html?id=UUID)
        const urlParams = new URLSearchParams(window.location.search);
        const farmerId = urlParams.get('id');

        async function initShop() {
            if (!farmerId) {
                document.getElementById('productList').innerHTML = `
                    <div class="bg-red-50 text-red-600 p-6 rounded-[30px] text-center border border-red-100">
                        <p class="font-bold">Ralat: Link Tidak Sah</p>
                        <p class="text-xs opacity-70">ID Peladang tidak dijumpai.</p>
                    </div>`;
                return;
            }

            // 1. Ambil Nama Ladang
            const { data: profile } = await _supabase.from('profiles').select('nama_ladang').eq('id', farmerId).single();
            if (profile) document.getElementById('shopName').innerText = profile.nama_ladang;

            // 2. Ambil Produk
            const { data: products, error } = await _supabase
                .from('produk')
                .select('*')
                .eq('user_id', farmerId)
                .gt('stok_kg', 0); // Hanya tunjuk stok yang ada

            const list = document.getElementById('productList');
            
            if (products && products.length > 0) {
                list.innerHTML = products.map(p => `
                    <div class="product-card p-6 shadow-sm flex justify-between items-center">
                        <div>
                            <h3 class="font-black text-xl text-slate-800 uppercase">${p.nama_barang}</h3>
                            <p class="text-emerald-600 font-black text-lg">RM ${p.harga_kg.toFixed(2)}<span class="text-[10px] text-slate-400">/KG</span></p>
                            <p class="text-[10px] font-bold text-slate-400 mt-1">STOK: ${p.stok_kg}KG TERSEDIA</p>
                        </div>
                        <button onclick="buatPesanan('${p.nama_barang}', ${p.harga_kg})" class="btn-order px-6 py-3 shadow-lg active:bg-emerald-700 transition-all">
                            PESAN
                        </button>
                    </div>
                `).join('');
            } else {
                list.innerHTML = `<p class="text-center text-slate-400 py-10 font-bold uppercase">Maaf, Stok Belum Tersedia</p>`;
            }
        }

        async function buatPesanan(namaBarang, harga) {
            const { value: formValues } = await Swal.fire({
                title: 'BORANG PESANAN',
                html: `
                    <div class="text-left space-y-3">
                        <label class="text-[10px] font-bold text-slate-400 uppercase">Nama Anda</label>
                        <input id="pembeli" class="w-full p-4 bg-slate-100 border-none rounded-2xl text-slate-800 font-bold" placeholder="Cth: Ali">
                        <label class="text-[10px] font-bold text-slate-400 uppercase">Berat (KG)</label>
                        <input id="berat" type="number" class="w-full p-4 bg-slate-100 border-none rounded-2xl text-slate-800 font-bold" placeholder="Berapa KG?">
                    </div>`,
                showCancelButton: true,
                confirmButtonText: 'HANTAR WHATSAPP',
                confirmButtonColor: '#10b981',
                preConfirm: () => {
                    return {
                        nama: document.getElementById('pembeli').value,
                        berat: document.getElementById('berat').value
                    }
                }
            });

            if (formValues && formValues.nama && formValues.berat) {
                const total = formValues.berat * harga;
                const mesej = `Salam, saya *${formValues.nama}* ingin memesan:\n\n` +
                              `Produk: *${namaBarang}*\n` +
                              `Berat: *${formValues.berat} KG*\n` +
                              `Total: *RM ${total.toFixed(2)}*\n\n` +
                              `Mohon sahkan pesanan saya. Terima kasih!`;
                
                // Gantikan nombor telefon ini dengan logic ambil dari profil peladang nanti
                window.open(`https://wa.me/60123456789?text=${encodeURIComponent(mesej)}`);
            }
        }

        initShop();
    </script>
</body>
</html>
