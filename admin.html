<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Kebun Pro - V3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #0f172a; color: white; }
        .card-style { background: #1e293b; border-radius: 20px; border: 1px solid #334155; padding: 15px; }
        input, select { background: #0f172a !important; color: white !important; border: 1px solid #334155 !important; font-size: 13px !important; padding: 10px !important; border-radius: 10px !important; width: 100%; }
        #map { height: 250px; border-radius: 15px; margin-top: 10px; border: 2px solid #334155; }
        .btn-green { background: #22c55e; color: #064e3b; font-weight: 800; padding: 12px; border-radius: 12px; font-size: 11px; }
        .btn-blue { background: #3b82f6; color: white; font-weight: 800; padding: 12px; border-radius: 12px; font-size: 11px; }
        label { font-size: 9px; color: #94a3b8; font-weight: 800; text-transform: uppercase; margin-bottom: 4px; display: block; }
    </style>
</head>
<body class="p-4 pb-24">

    <div class="max-w-md mx-auto space-y-8">
        
        <div id="loginSection" class="hidden pt-20 space-y-6">
            <h1 class="text-3xl font-black text-green-400 text-center uppercase">Admin Login</h1>
            <div class="space-y-3">
                <input id="email" type="email" placeholder="Emel">
                <input id="password" type="password" placeholder="Password">
                <button onclick="handleLogin()" class="w-full btn-green py-4 text-sm">MASUK</button>
            </div>
        </div>

        <div id="dashboardSection" class="hidden space-y-8">
            <div class="flex justify-between items-center bg-slate-800/50 p-4 rounded-2xl border border-slate-700">
                <a id="shopLink" href="#" target="_blank" class="text-xs font-black text-blue-400">üîó LINK KEDAI</a>
                <button onclick="handleLogout()" class="text-[10px] font-bold text-red-400 uppercase">Logout</button>
            </div>

            <section>
                <h3 class="text-xs font-black text-green-400 uppercase mb-4">üì¶ Pesanan Pelanggan</h3>
                <div id="orderContainer" class="space-y-3"></div>
            </section>

            <section>
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xs font-black text-green-400 uppercase">üçé Produk Jualan</h3>
                    <button onclick="tambahProdukBaru()" class="text-[10px] font-bold text-blue-400 underline">+ TAMBAH</button>
                </div>
                <div id="stockContainer" class="grid grid-cols-2 gap-3"></div>
            </section>

            <section class="card-style space-y-5">
                <h3 class="text-xs font-black text-orange-400 uppercase">üìä Kalkulator COGS</h3>
                
                <div class="space-y-2">
                    <label>Nama Fail / Ladang</label>
                    <div class="flex gap-2">
                        <input id="cogs_filename" placeholder="Cth: Musim Kangkung 1">
                        <button onclick="simpanCOGS()" class="bg-blue-600 px-4 rounded-xl text-[10px] font-bold">SIMPAN</button>
                    </div>
                    <select id="cogs_saved_list" onchange="muatCOGS(this.value)" class="mt-2">
                        <option value="">-- Muat Fail Lama --</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-3 border-t border-slate-700 pt-4">
                    <div><label>Bil. Pokok</label><input type="number" id="c_pokok" oninput="kiraCOGS()"></div>
                    <div><label>Hasil/Pokok (KG)</label><input type="number" id="c_hasil" oninput="kiraCOGS()"></div>
                </div>

                <div class="grid grid-cols-2 gap-2">
                    <input type="number" id="k_benih" placeholder="Benih (RM)" oninput="kiraCOGS()">
                    <input type="number" id="k_baja" placeholder="Baja (RM)" oninput="kiraCOGS()">
                    <input type="number" id="k_racun" placeholder="Racun (RM)" oninput="kiraCOGS()">
                    <input type="number" id="k_upah" placeholder="Upah (RM)" oninput="kiraCOGS()">
                </div>

                <div class="bg-orange-500 p-4 rounded-xl text-slate-900 text-center">
                    <p class="text-[9px] font-black uppercase">Kos Pengeluaran</p>
                    <h2 id="res_per_kg" class="text-3xl font-black tracking-tighter text-slate-950">RM 0.00 / KG</h2>
                </div>
            </section>
        </div>
    </div>

    <div id="modalEdit" class="fixed inset-0 bg-black/80 hidden z-50 p-4 overflow-y-auto">
        <div class="bg-slate-800 p-6 rounded-[30px] max-w-md mx-auto space-y-4">
            <h3 class="text-lg font-black text-green-400 uppercase">Kemaskini Produk</h3>
            <div id="editFields" class="space-y-3"></div>
            
            <div class="space-y-1">
                <label>Pilih Lokasi Jualan (Tarik Pin)</label>
                <div id="map"></div>
                <button onclick="getLokasiSekarang()" class="w-full mt-2 text-[10px] bg-slate-700 py-2 rounded-lg font-bold">üìç GUNA LOKASI SEKARANG</button>
            </div>

            <div class="flex gap-2 pt-4">
                <button onclick="tutupModal()" class="flex-1 bg-slate-700 py-4 rounded-2xl font-bold">BATAL</button>
                <button id="btnSimpanProduk" class="flex-1 btn-green py-4 rounded-2xl">SIMPAN</button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = "https://gbjrvrdsmajwajnhsodt.supabase.co";
        const SUPABASE_KEY = "sb_publishable_fp0mnEYNTgc7QexmOP3njg_VK6W6832";
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let currentUser = null, map, marker, selectedProdukId = null;

        // 1. AUTH & SESSION
        async function checkSession() {
            const { data: { session } } = await _supabase.auth.getSession();
            if (session) {
                currentUser = session.user;
                document.getElementById('shopLink').href = `index.html?id=${currentUser.id}`;
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('dashboardSection').classList.remove('hidden');
                muatData();
                muatSenaraiFailCOGS();
            } else { document.getElementById('loginSection').classList.remove('hidden'); }
        }

        // 2. MUAT DATA
        async function muatData() {
            const { data: orders } = await _supabase.from('pesanan').select('*').eq('peladang_id', currentUser.id).order('id', {ascending:false});
            const { data: products } = await _supabase.from('produk').select('*').eq('user_id', currentUser.id);
            
            // Render Orders
            document.getElementById('orderContainer').innerHTML = orders?.map(o => `
                <div class="card-style flex justify-between items-center">
                    <div><p class="text-xs font-black uppercase text-white">${o.nama_pelanggan}</p><p class="text-[9px] text-slate-500">${o.produk_nama} (${o.berat_kg}kg)</p></div>
                    <div class="flex gap-2">
                        <a href="tel:${o.no_tel}" class="p-2 bg-slate-700 rounded-lg text-xs">üìû</a>
                        <button onclick="padamItem('pesanan', ${o.id})" class="p-2 bg-red-900/20 text-red-500 rounded-lg text-xs">üóëÔ∏è</button>
                    </div>
                </div>`).join('') || '';

            // Render Produk (Ringkas)
            document.getElementById('stockContainer').innerHTML = products?.map(p => `
                <button onclick='bukaModalEdit(${JSON.stringify(p)})' class="card-style text-left hover:border-green-500 transition-all">
                    <p class="text-[10px] font-black text-green-400 uppercase">${p.nama_barang}</p>
                    <p class="text-xl font-black">RM ${p.harga_kg}</p>
                    <p class="text-[9px] text-slate-500 font-bold uppercase">Stok: ${p.stok_kg}kg</p>
                </button>`).join('') || '';
        }

        // 3. COGS SYSTEM (SAVE/LOAD)
        function kiraCOGS() {
            const hasil = (parseFloat(document.getElementById('c_pokok').value)||0) * (parseFloat(document.getElementById('c_hasil').value)||0);
            const kos = ['k_benih','k_baja','k_racun','k_upah'].reduce((acc,id)=> acc + (parseFloat(document.getElementById(id).value)||0), 0);
            const res = hasil > 0 ? (kos / hasil).toFixed(2) : "0.00";
            document.getElementById('res_per_kg').innerText = `RM ${res} / KG`;
        }

        async function simpanCOGS() {
            const nama = document.getElementById('cogs_filename').value;
            if(!nama) return Swal.fire("Ralat", "Sila letak nama fail", "error");
            const data = {
                pokok: document.getElementById('c_pokok').value,
                hasil_pokok: document.getElementById('c_hasil').value,
                benih: document.getElementById('k_benih').value,
                baja: document.getElementById('k_baja').value,
                racun: document.getElementById('k_racun').value,
                upah: document.getElementById('k_upah').value
            };
            await _supabase.from('cogs_data').upsert([{ user_id: currentUser.id, nama_fail: nama, data }]);
            Swal.fire("Berjaya", "COGS Disimpan", "success");
            muatSenaraiFailCOGS();
        }

        async function muatSenaraiFailCOGS() {
            const { data } = await _supabase.from('cogs_data').select('*').eq('user_id', currentUser.id);
            const select = document.getElementById('cogs_saved_list');
            select.innerHTML = '<option value="">-- Muat Fail Lama --</option>' + 
                data.map(f => `<option value='${JSON.stringify(f.data)}'>${f.nama_fail}</option>`).join('');
        }

        function muatCOGS(jsonStr) {
            if(!jsonStr) return;
            const d = JSON.parse(jsonStr);
            document.getElementById('c_pokok').value = d.pokok;
            document.getElementById('c_hasil').value = d.hasil_pokok;
            document.getElementById('k_benih').value = d.benih;
            document.getElementById('k_baja').value = d.baja;
            document.getElementById('k_racun').value = d.racun;
            document.getElementById('k_upah').value = d.upah;
            kiraCOGS();
        }

        // 4. MAPS & MODAL EDIT
        function bukaModalEdit(p) {
            selectedProdukId = p.id;
            document.getElementById('editFields').innerHTML = `
                <div class="grid grid-cols-2 gap-2">
                    <div><label>Nama Barang</label><input id="e_nama" value="${p.nama_barang}"></div>
                    <div><label>Harga / KG</label><input id="e_harga" type="number" value="${p.harga_kg}"></div>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <div><label>Stok Asal (KG)</label><input id="e_stok" type="number" value="${p.stok_kg}"></div>
                    <div><label>Lokasi (Teks)</label><input id="e_lokasi" value="${p.lokasi||''}" placeholder="Cth: Pasar Tronoh"></div>
                </div>
                <input id="e_maps" type="hidden" value="${p.google_maps||''}">
            `;
            document.getElementById('modalEdit').classList.remove('hidden');
            initMap(p.google_maps);
            document.getElementById('btnSimpanProduk').onclick = () => simpanProduk(p.id);
        }

        function initMap(coords) {
            const defaultPos = coords ? coords.split(',').map(Number) : [4.4191, 100.9929];
            if(map) map.remove();
            map = L.map('map').setView(defaultPos, 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            marker = L.marker(defaultPos, {draggable: true}).addTo(map);
            marker.on('dragend', () => {
                const pos = marker.getLatLng();
                document.getElementById('e_maps').value = `${pos.lat},${pos.lng}`;
            });
        }

        function getLokasiSekarang() {
            navigator.geolocation.getCurrentPosition(pos => {
                const p = [pos.coords.latitude, pos.coords.longitude];
                map.setView(p, 15);
                marker.setLatLng(p);
                document.getElementById('e_maps').value = `${p[0]},${p[1]}`;
            });
        }

        async function simpanProduk(id) {
            const updates = {
                nama_barang: document.getElementById('e_nama').value,
                harga_kg: document.getElementById('e_harga').value,
                stok_kg: document.getElementById('e_stok').value,
                lokasi: document.getElementById('e_lokasi').value,
                google_maps: document.getElementById('e_maps').value
            };
            await _supabase.from('produk').update(updates).eq('id', id);
            tutupModal(); muatData();
            Swal.fire("Berjaya", "Produk Dikemaskini", "success");
        }

        function tutupModal() { document.getElementById('modalEdit').classList.add('hidden'); }
        async function handleLogin() { 
            const { error } = await _supabase.auth.signInWithPassword({ email: email.value, password: password.value });
            if(error) Swal.fire("Ralat", error.message, "error"); else location.reload();
        }
        async function handleLogout() { await _supabase.auth.signOut(); location.reload(); }
        async function padamItem(table, id) {
            const { isConfirmed } = await Swal.fire({ title: 'Padam?', icon: 'warning', showCancelButton: true });
            if (isConfirmed) { await _supabase.from(table).delete().eq('id', id); muatData(); }
        }
        async function tambahProdukBaru() {
            await _supabase.from('produk').insert([{ user_id: currentUser.id, nama_barang: 'BARANG BARU', harga_kg: 0, stok_kg: 0 }]);
            muatData();
        }

        window.onload = checkSession;
    </script>
</body>
</html>
