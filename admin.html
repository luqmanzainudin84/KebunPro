<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Kebun Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #0f172a; color: white; }
        .card-style { background: #1e293b; border-radius: 20px; border: 1px solid #334155; padding: 15px; }
        input, select { background: #0f172a !important; color: white !important; border: 1px solid #334155 !important; font-size: 13px !important; padding: 10px !important; border-radius: 10px !important; width: 100%; }
        #map { height: 250px; border-radius: 15px; margin-top: 10px; border: 2px solid #334155; }
        .btn-action { font-weight: 800; text-align: center; font-size: 10px; padding: 12px; border-radius: 12px; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
        label { font-size: 9px; color: #94a3b8; font-weight: 800; text-transform: uppercase; margin-bottom: 4px; display: block; }
    </style>
</head>
<body class="p-4 pb-24">

    <div class="max-w-md mx-auto space-y-8">
        
        <div id="loginSection" class="hidden pt-20 space-y-6">
            <h1 class="text-3xl font-black text-green-400 text-center">ADMIN LOGIN</h1>
            <div class="space-y-3">
                <input id="email" type="email" placeholder="Emel">
                <input id="password" type="password" placeholder="Password">
                <button onclick="handleLogin()" class="w-full bg-green-500 text-slate-900 font-black py-4 rounded-2xl">MASUK</button>
            </div>
        </div>

        <div id="dashboardSection" class="hidden space-y-8">
            <div class="flex justify-between items-center bg-slate-800/50 p-4 rounded-2xl border border-slate-700">
                <a id="shopLink" href="#" target="_blank" class="text-xs font-black text-blue-400 underline">KEDAI SAYA üîó</a>
                <button onclick="handleLogout()" class="text-[10px] font-bold text-red-400">LOGOUT</button>
            </div>

            <section>
                <h3 class="text-xs font-black text-green-400 uppercase mb-4 tracking-widest">üì¶ Pesanan Pelanggan</h3>
                <div id="orderContainer" class="space-y-4"></div>
            </section>

            <section>
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xs font-black text-green-400 uppercase tracking-widest">üçé Produk Jualan</h3>
                    <button onclick="tambahProdukBaru()" class="text-[10px] font-bold text-blue-400">+ TAMBAH</button>
                </div>
                <div id="stockContainer" class="grid grid-cols-2 gap-3"></div>
            </section>

            <section class="card-style space-y-5">
                <h3 class="text-xs font-black text-orange-400 uppercase">üìä Kalkulator COGS</h3>
                <div class="space-y-2">
                    <label>Nama Fail / Ladang</label>
                    <div class="flex gap-2">
                        <input id="cogs_filename" placeholder="Cth: Musim Kangkung 1">
                        <button onclick="simpanCOGS()" class="bg-blue-600 px-4 rounded-xl text-[10px] font-bold">SIMPAN</button>
                    </div>
                    <select id="cogs_saved_list" onchange="muatCOGS(this.value)" class="mt-2"></select>
                </div>
                <div class="grid grid-cols-2 gap-3 border-t border-slate-700 pt-4">
                    <div><label>Bil. Pokok</label><input type="number" id="c_pokok" oninput="kiraCOGS()"></div>
                    <div><label>Hasil/Pokok (KG)</label><input type="number" id="c_hasil" oninput="kiraCOGS()"></div>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <input type="number" id="k_benih" placeholder="Benih (RM)" oninput="kiraCOGS()">
                    <input type="number" id="k_baja" placeholder="Baja (RM)" oninput="kiraCOGS()">
                    <input type="number" id="k_racun" placeholder="Racun (RM)" oninput="kiraCOGS()">
                    <input type="number" id="k_upah" placeholder="Upah (RM)" oninput="kiraCOGS()">
                </div>
                <div class="bg-orange-500 p-4 rounded-xl text-slate-900 text-center">
                    <p class="text-[9px] font-black uppercase">Kos Pengeluaran</p>
                    <h2 id="res_per_kg" class="text-3xl font-black">RM 0.00 / KG</h2>
                </div>
            </section>
        </div>
    </div>

    <div id="modalEdit" class="fixed inset-0 bg-black/80 hidden z-50 p-4 overflow-y-auto">
        <div class="bg-slate-800 p-6 rounded-[30px] max-w-md mx-auto space-y-4 shadow-2xl">
            <h3 class="text-lg font-black text-green-400 uppercase">Kemaskini Produk</h3>
            <div id="editFields" class="space-y-3"></div>
            <div class="space-y-1"><label>Tarik Pin Lokasi Jualan</label><div id="map"></div></div>
            <button onclick="getLokasiSekarang()" class="w-full bg-slate-700 py-3 rounded-xl text-[10px] font-bold">üìç GUNA LOKASI SAYA</button>
            <div class="flex gap-2 pt-4">
                <button onclick="tutupModal()" class="flex-1 bg-slate-700 py-4 rounded-2xl font-bold">BATAL</button>
                <button id="btnSimpanProduk" class="flex-1 bg-green-500 text-slate-900 py-4 rounded-2xl font-bold uppercase">Simpan</button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = "https://gbjrvrdsmajwajnhsodt.supabase.co";
        const SUPABASE_KEY = "sb_publishable_fp0mnEYNTgc7QexmOP3njg_VK6W6832";
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let currentUser = null, map, marker;

        async function checkSession() {
            const { data: { session } } = await _supabase.auth.getSession();
            if (session) {
                currentUser = session.user;
                document.getElementById('shopLink').href = `index.html?id=${currentUser.id}`;
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('dashboardSection').classList.remove('hidden');
                muatData(); muatSenaraiFailCOGS();
            } else { document.getElementById('loginSection').classList.remove('hidden'); }
        }

        function formatWhatsApp(phone) {
            let p = phone.replace(/\D/g, ''); // Buang simbol
            if (p.startsWith('0')) p = '6' + p; // Tukar 01... jadi 601...
            if (p.startsWith('1')) p = '60' + p; // Tukar 1... jadi 601...
            return p;
        }

        async function muatData() {
            const { data: orders } = await _supabase.from('pesanan').select('*').eq('peladang_id', currentUser.id).order('id', {ascending:false});
            const { data: products } = await _supabase.from('produk').select('*').eq('user_id', currentUser.id);
            
            document.getElementById('orderContainer').innerHTML = orders?.map(o => {
                const waPhone = formatWhatsApp(o.no_tel);
                return `
                <div class="card-style space-y-4 border-l-4 ${o.status_bayar && o.status_ambil ? 'border-green-500' : 'border-slate-700'}">
                    <div class="flex justify-between border-b border-slate-700/50 pb-2">
                        <div><p class="text-sm font-black text-white uppercase">${o.nama_pelanggan}</p><p class="text-[10px] text-slate-500">${o.no_tel}</p></div>
                        <div class="text-right"><p class="font-black text-green-400">RM ${parseFloat(o.jumlah_harga).toFixed(2)}</p><p class="text-[9px] text-slate-500 uppercase">${o.produk_nama}</p></div>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <a href="https://wa.me/${waPhone}" target="_blank" class="btn-action bg-blue-600 text-white">WHATSAPP</a>
                        <a href="tel:${o.no_tel}" class="btn-action bg-slate-700 text-white">CALL</a>
                        <button onclick="kemaskiniStatus(${o.id}, 'status_bayar', ${o.status_bayar})" class="btn-action ${o.status_bayar ? 'bg-green-600' : 'bg-slate-800 text-slate-500'}">${o.status_bayar ? '‚úÖ DAH BAYAR' : 'üí∞ BAYAR'}</button>
                        <button onclick="kemaskiniStatus(${o.id}, 'status_ambil', ${o.status_ambil})" class="btn-action ${o.status_ambil ? 'bg-orange-600' : 'bg-slate-800 text-slate-500'}">${o.status_ambil ? '‚úÖ DAH AMBIL' : 'üì¶ AMBIL'}</button>
                    </div>
                    ${o.link_resit ? `<button onclick="Swal.fire({imageUrl:'${o.link_resit}'})" class="w-full py-2 bg-purple-900/30 text-purple-400 text-[9px] font-bold rounded-lg border border-purple-900/50 uppercase">Lihat Resit Pembayaran</button>` : ''}
                    <div class="flex justify-end"><button onclick="padamItem('pesanan', ${o.id})" class="text-red-500 opacity-30 text-[9px] font-bold">PADAM PESANAN</button></div>
                </div>`}).join('') || '<p class="text-center py-10">Tiada Pesanan</p>';

            document.getElementById('stockContainer').innerHTML = products?.map(p => {
                const totalDipesan = orders ? orders.filter(o => o.produk_nama === p.nama_barang).reduce((sum, o) => sum + parseFloat(o.berat_kg), 0) : 0;
                return `
                <button onclick='bukaModalEdit(${JSON.stringify(p)})' class="card-style text-left border-t-2 border-green-500">
                    <p class="text-[9px] font-black text-green-400 uppercase">${p.nama_barang}</p>
                    <p class="text-lg font-black">RM ${p.harga_kg}</p>
                    <p class="text-[9px] text-slate-500 font-bold uppercase">Stok: ${p.stok_kg - totalDipesan}kg</p>
                </button>`;
            }).join('') || '';
        }

        async function kemaskiniStatus(id, kolom, status) {
            await _supabase.from('pesanan').update({ [kolom]: !status }).eq('id', id);
            muatData();
        }

        function kiraCOGS() {
            const hasil = (parseFloat(document.getElementById('c_pokok').value)||0) * (parseFloat(document.getElementById('c_hasil').value)||0);
            const kos = ['k_benih','k_baja','k_racun','k_upah'].reduce((acc,id)=> acc + (parseFloat(document.getElementById(id).value)||0), 0);
            document.getElementById('res_per_kg').innerText = hasil > 0 ? `RM ${(kos/hasil).toFixed(2)} / KG` : "RM 0.00 / KG";
        }

        async function simpanCOGS() {
            const nama = document.getElementById('cogs_filename').value;
            if(!nama) return Swal.fire("Ralat", "Sila isi nama fail", "error");
            const data = { pokok: document.getElementById('c_pokok').value, hasil: document.getElementById('c_hasil').value, benih: document.getElementById('k_benih').value, baja: document.getElementById('k_baja').value, racun: document.getElementById('k_racun').value, upah: document.getElementById('k_upah').value };
            await _supabase.from('cogs_data').upsert([{ user_id: currentUser.id, nama_fail: nama, data }]);
            Swal.fire("Simpan", "Data COGS berjaya disimpan", "success"); muatSenaraiFailCOGS();
        }

        async function muatSenaraiFailCOGS() {
            const { data } = await _supabase.from('cogs_data').select('*').eq('user_id', currentUser.id);
            const select = document.getElementById('cogs_saved_list');
            select.innerHTML = '<option value="">-- Muat Fail COGS --</option>' + data.map(f => `<option value='${JSON.stringify(f.data)}'>${f.nama_fail}</option>`).join('');
        }

        function muatCOGS(str) {
            if(!str) return; const d = JSON.parse(str);
            document.getElementById('c_pokok').value = d.pokok; document.getElementById('c_hasil').value = d.hasil;
            document.getElementById('k_benih').value = d.benih; document.getElementById('k_baja').value = d.baja;
            document.getElementById('k_racun').value = d.racun; document.getElementById('k_upah').value = d.upah;
            kiraCOGS();
        }

        function bukaModalEdit(p) {
            document.getElementById('editFields').innerHTML = `
                <div class="grid grid-cols-2 gap-2">
                    <div><label>Nama Barang</label><input id="e_nama" value="${p.nama_barang}"></div>
                    <div><label>Harga / KG</label><input id="e_harga" type="number" value="${p.harga_kg}"></div>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <div><label>Stok Asal (KG)</label><input id="e_stok" type="number" value="${p.stok_kg}"></div>
                    <div><label>Lokasi (Teks)</label><input id="e_lokasi" value="${p.lokasi||''}"></div>
                </div>
                <input id="e_maps" type="hidden" value="${p.google_maps||''}">`;
            document.getElementById('modalEdit').classList.remove('hidden');
            initMap(p.google_maps);
            document.getElementById('btnSimpanProduk').onclick = () => simpanProduk(p.id);
        }

        function initMap(coords) {
            const pos = coords ? coords.split(',').map(Number) : [4.4191, 100.9929];
            if(map) map.remove();
            map = L.map('map').setView(pos, 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            marker = L.marker(pos, {draggable: true}).addTo(map);
            marker.on('dragend', () => { const p = marker.getLatLng(); document.getElementById('e_maps').value = `${p.lat},${p.lng}`; });
        }

        function getLokasiSekarang() {
            navigator.geolocation.getCurrentPosition(p => {
                const pos = [p.coords.latitude, p.coords.longitude];
                map.setView(pos, 15); marker.setLatLng(pos);
                document.getElementById('e_maps').value = `${pos[0]},${pos[1]}`;
            });
        }

        async function simpanProduk(id) {
            const upd = { nama_barang: document.getElementById('e_nama').value, harga_kg: document.getElementById('e_harga').value, stok_kg: document.getElementById('e_stok').value, lokasi: document.getElementById('e_lokasi').value, google_maps: document.getElementById('e_maps').value };
            await _supabase.from('produk').update(upd).eq('id', id);
            tutupModal(); muatData(); Swal.fire("Berjaya", "Data dikemaskini", "success");
        }

        function tutupModal() { document.getElementById('modalEdit').classList.add('hidden'); }
        async function handleLogin() { const { error } = await _supabase.auth.signInWithPassword({ email: email.value, password: password.value }); if(error) Swal.fire("Ralat", error.message, "error"); else location.reload(); }
        async function handleLogout() { await _supabase.auth.signOut(); location.reload(); }
        async function padamItem(table, id) { if((await Swal.fire({title:'Padam?', showCancelButton:true})).isConfirmed){ await _supabase.from(table).delete().eq('id', id); muatData(); } }
        async function tambahProdukBaru() { await _supabase.from('produk').insert([{ user_id: currentUser.id, nama_barang: 'BARU', harga_kg: 0, stok_kg: 0 }]); muatData(); }

        window.onload = checkSession;
    </script>
</body>
</html>
